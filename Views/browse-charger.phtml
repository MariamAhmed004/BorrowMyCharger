<head>
  <style>
    .container-custom {
      display: flex;
      flex-wrap: wrap;
      margin: 2rem auto;
      width: 90%;
      max-width: 1200px;
    }

    .left-panel {
      width: 100%;
      padding: 20px;
      background-color: white;
      border: 1px solid black;
      margin-bottom: 20px;
    }

    .form-control {
      border-radius: 0;
      margin-bottom: 1rem;
    }

    .btn-search {
      background-color: #0099cc;
      color: white;
      border-radius: 0;
      width: 100%;
    }

    .btn-search:hover {
      background-color: #0077aa;
    }

    .map-box {
      width: 100%;
      height: 400px;
      background-color: #ccc;
      margin-bottom: 20px;
    }

    #map {
      height: 100%;
    }

    /* Card layout - Fixed width, wrap to new row */
    #chargePointsContainer {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start; /* Align cards to the start of the row */
    }

    .charge-point {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 20px;
      background-color: white;
      border: 1px solid black;
      margin: 10px;
      color: black;
      width: 300px; /* Fixed width for each card */
      box-sizing: border-box;
    }

    .charge-point img {
      width: 80px;
      height: 80px;
      margin-bottom: 10px;
    }

    /* Responsive Design for different screen sizes */
    @media (max-width: 1200px) {
      .charge-point {
        width: 300px; /* Keep fixed width for large tablets and above */
      }
    }

    @media (max-width: 992px) {
      .charge-point {
        width: 300px; /* Keep fixed width for medium screens (tablets) */
      }
    }

    @media (max-width: 768px) {
      .charge-point {
        width: 300px; /* Keep fixed width for small tablets */
      }
    }

    @media (max-width: 576px) {
      .charge-point {
        width: 100%; /* Full width on small screens (phones) */
        margin: 10px 0; /* Adjust margin to prevent horizontal overflow */
      }
    }

    /* Filter Layout */
    .filter-row {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .filter-item {
      margin-right: 10px;
    }

    .filter-item:last-child {
      margin-right: 0;
    }

    .btn {
      border-radius: 20px;
    }

    .form-control {
      width: auto;
    }
  </style>
</head>

<body>
<?php require('template/header.phtml') ?>

<!-- Main Content -->
<div class="container-custom">
  <!-- Left Panel -->
  <div class="left-panel">
    <h5><strong>Filters</strong></h5>
    <div class="filter-row">
      <select class="form-control filter-item" id="locationSelect">
        <option value="">Location</option>
        <?php foreach ($view->cities as $city): ?>
          <option value="<?= htmlspecialchars($city['city_id']) ?>">
            <?= htmlspecialchars($city['city_name']) ?>
          </option>
        <?php endforeach; ?>
      </select>
      <select class="form-control filter-item" id="priceRangeSelect">
        <option value="">Price Range (BHD)</option>
        <option value="0-2">0 BHD - 2 BHD</option>
        <option value="2-5">2 BHD - 5 BHD</option>
        <option value="5-10">5 BHD - 10 BHD</option>
        <option value="10-20">10 BHD - 20 BHD</option>
      </select>
      <select class="form-control filter-item" id="availabilitySelect">
        <option value="">Availability</option>
             <?php foreach ($view->availabilityStatus as $status): ?>
        <option value="<?= htmlspecialchars($status['availability_status_id']) ?>">
            <?= htmlspecialchars($status['availability_status_title']) ?>
          </option>
        <?php endforeach; ?>
      </select>
      <button class="btn btn-secondary filter-item" id="resetBtn">Reset</button>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="map-box mb-4" id="map"></div>

  <!-- Charge Points -->
  <div id="chargePointsContainer">
    <?php if (!empty($view->chargePoints)): ?>
      <?php foreach ($view->chargePoints as $chargePoint): ?>
        <div class="charge-point">
          <img src="<?= htmlspecialchars($chargePoint['chargePointPictureUrl']) ?>" alt="Charge Point Image">
          <div>
            <h5><strong>Charge Point</strong></h5>
            <p>
              <?= htmlspecialchars('Block ' . $chargePoint['block'] . ', Road ' . $chargePoint['road'] . ', House ' . $chargePoint['houseNumber'] . ', ' . $chargePoint['streetName'] . ', Postcode ' . $chargePoint['postcode']) ?>
            </p>
            <p>
              <?= htmlspecialchars($chargePoint['cityName'] . ', ' . $chargePoint['countryName']) ?>
            </p>
            <p><?= htmlspecialchars(number_format($chargePoint['pricePerKwh'], 3)) ?> BHD per kWh</p>
            <p>Availability: <?= htmlspecialchars($chargePoint['availabilityStatusTitle']) ?></p>
            <button class="btn btn-success">View</button>
          </div>
        </div>
      <?php endforeach; ?>
    <?php else: ?>
      <p>No charge points available.</p>
    <?php endif; ?>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Map init
  var map = L.map('map').setView([26.0667, 50.5577], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  L.marker([26.0667, 50.5577]).addTo(map).bindPopup('Budaiya, Bahrain').openPopup();

  // Reset button functionality
  document.getElementById('resetBtn').onclick = function() {
    document.getElementById('locationSelect').selectedIndex = 0;
    document.getElementById('priceRangeSelect').selectedIndex = 0;
    document.getElementById('availabilitySelect').selectedIndex = 0;
    loadChargePoints();
  };

  // Event listeners for filter changes
  document.getElementById('locationSelect').addEventListener('change', loadChargePoints);
  document.getElementById('priceRangeSelect').addEventListener('change', loadChargePoints);
  document.getElementById('availabilitySelect').addEventListener('change', loadChargePoints);

  function loadChargePoints() {
    var location = document.getElementById('locationSelect').value;
    var priceRange = document.getElementById('priceRangeSelect').value;
    var availability = document.getElementById('availabilitySelect').value;

    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'browse-charger.php?ajax=true&location=' + location + '&priceRange=' + priceRange + '&availability=' + availability, true);
    xhr.onload = function() {
      if (xhr.status === 200) {
        document.getElementById('chargePointsContainer').innerHTML = xhr.responseText;
      } else {
        console.error('Error fetching charge points:', xhr.statusText);
      }
    };
    xhr.onerror = function() {
      console.error('Request error...');
    };
    xhr.send();
  }
</script>
<?php require('template/footer.phtml') ?>
</body>